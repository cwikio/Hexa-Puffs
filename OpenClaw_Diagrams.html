<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Architecture Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f8f9fa; color: #2c3e50; padding: 40px; }
        h1 { font-size: 28px; color: #1a5276; margin-bottom: 8px; }
        h2 { font-size: 22px; color: #2c3e50; margin: 40px 0 16px; }
        p { font-size: 15px; color: #7f8c8d; margin-bottom: 24px; line-height: 1.5; }
        .subtitle { font-size: 16px; color: #7f8c8d; margin-bottom: 32px; }
        .diagram-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 24px;
            margin: 16px 0 40px;
            overflow-x: auto;
        }
        .mermaid { display: flex; justify-content: center; }
        hr { border: none; border-top: 2px solid #1a5276; margin: 48px 0; width: 200px; }
    </style>
</head>
<body>
    <h1>OpenClaw Architecture Diagrams</h1>
    <div class="subtitle">Prepared for Tomasz Cwik â€” February 2026</div>

    <h2>Decision-Making Flowchart: How OpenClaw Processes a Request</h2>
    <p>Every decision point from message arrival to response delivery. Red = rejection paths, purple = streaming loop, orange = tool backfill cycle.</p>
    <div class="diagram-container">
        <pre class="mermaid">
flowchart TD
    A["ðŸ“¨ Inbound Message\n(WhatsApp / Telegram / Discord / Slack / ...)"] --> B["Channel Adapter\nNormalize to unified envelope"]
    B --> C{"Sender\nKnown?"}
    C -->|No| D["Pairing Gate\nSend approval code"]
    D --> E["â›” No Execution\nAwait pairing"]
    C -->|Yes| F{"Access\nAllowed?"}
    F -->|No| G["â›” Blocked\nDM policy / allowlist deny"]
    F -->|Yes| H{"Group Chat?"}
    H -->|Yes| I{"Mention\nRequired?"}
    I -->|Yes, not mentioned| J["â›” Ignored\nNo @mention"]
    I -->|No / Mentioned| K["Resolve Session"]
    H -->|No / DM| K
    K --> L{"Active Run\non Session?"}
    L -->|Yes| M["Enqueue in Lane\nWait for current run"]
    L -->|No| N["Dispatch to\nPiEmbeddedRunner"]
    M --> N
    N --> O["Phase 1: Load Session State\nJSONL from disk"]
    O --> P["Phase 2: Assemble Context\nSOUL.md + AGENTS.md + TOOLS.md\n+ memory search + history"]
    P --> Q["Phase 3: Stream Model Response\nTokens â†’ User in real-time"]
    Q --> R{"Tool Call\nDetected in Stream?"}
    R -->|No| S{"Model\nDone?"}
    S -->|No| Q
    S -->|Yes| T["Phase 4: Persist State\nAppend to JSONL"]
    T --> U["âœ… Response Delivered\nvia Channel Adapter"]
    R -->|Yes| V{"Tool\nAllowed by Policy?"}
    V -->|No| W["Return Error\nto Model"]
    W --> Q
    V -->|Yes| X{"Sandbox\nMode?"}
    X -->|Docker| Y["Execute in\nEphemeral Container"]
    X -->|Host| Z["Execute on\nHost OS"]
    Y --> AA["Backfill Result\ninto Stream"]
    Z --> AA
    AA --> Q
    style A fill:#3498DB,stroke:#2C3E50,color:#fff
    style E fill:#E74C3C,stroke:#C0392B,color:#fff
    style G fill:#E74C3C,stroke:#C0392B,color:#fff
    style J fill:#E74C3C,stroke:#C0392B,color:#fff
    style U fill:#27AE60,stroke:#1E8449,color:#fff
    style N fill:#1A5276,stroke:#154360,color:#fff
    style Q fill:#8E44AD,stroke:#6C3483,color:#fff
    style AA fill:#F39C12,stroke:#D68910,color:#fff
        </pre>
    </div>

    <hr>

    <h2>Waterfall Sequence Diagram: Request Flow Through Components Over Time</h2>
    <p>Temporal flow across all ten components â€” user, channel adapter, Gateway, lane queue, agent runtime, context assembly, memory, LLM, tool policy, and sandbox.</p>
    <div class="diagram-container">
        <pre class="mermaid">
sequenceDiagram
    autonumber
    participant U as User
    participant CH as Channel Adapter
    participant GW as Gateway (WS:18789)
    participant Q as Lane Queue
    participant PI as PiEmbeddedRunner
    participant CTX as Context Assembler
    participant MEM as SQLite Memory (BM25 + Vector)
    participant LLM as LLM Provider (Claude/OpenAI)
    participant TP as Tool Policy
    participant SB as Sandbox (Docker/Host)

    U->>CH: Send message
    Note over CH: Normalize to unified envelope
    CH->>GW: Envelope {body, sender, media}
    Note over GW: Access Control
    GW->>GW: Check pairing + DM policy
    GW->>GW: Resolve session key
    GW->>Q: Enqueue in session lane
    Note over Q: Default Serial
    Q->>Q: Wait if active run exists
    Q->>PI: Dispatch when lane is free

    rect rgb(230, 240, 250)
        Note over PI,SB: Agent Runtime Loop (piembeddedrunner.ts)
        PI->>PI: Phase 1: Load session state from JSONL
        PI->>CTX: Phase 2: Assemble context
        CTX->>CTX: Read SOUL.md + AGENTS.md + TOOLS.md
        CTX->>MEM: Hybrid search (query)
        MEM-->>CTX: BM25 + vector results (70/30)
        CTX->>CTX: Merge history + skill metadata
        CTX-->>PI: Compiled system prompt
        PI->>LLM: Phase 3: Stream request
        loop Streaming Response
            LLM-->>PI: Token stream
            PI-->>CH: Forward tokens to user
            CH-->>U: Real-time response
            alt Tool call detected
                PI->>TP: Check tool policy
                alt Tool denied
                    TP-->>PI: Denied
                    PI->>LLM: Error result
                else Tool allowed
                    TP-->>PI: Allowed
                    PI->>SB: Execute tool
                    Note over SB: Docker or Host
                    SB-->>PI: Tool result
                    PI->>LLM: Backfill result
                end
            end
        end
        Note over PI: Model signals done
        PI->>PI: Phase 4: Persist state
        PI->>MEM: Write memories + embeddings
        PI->>PI: Append to JSONL
    end

    PI-->>GW: Run complete
    GW->>Q: Release lane
    GW-->>CH: Final response
    CH-->>U: Delivery confirmation
        </pre>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose' });
    </script>
</body>
</html>
